image: registry.gitlab.tugraz.at/dbp/web-components/toolkit/main:v1

cache:
  key: ${CI_PROJECT_PATH}
  paths:
    - _yarn_cache

stages:
  - test
  - publish

test:
  stage: test
  script:
    - yarn config set cache-folder "$CI_PROJECT_DIR/_yarn_cache"
    - yarn install
    - yarn run test

publish:
  stage: publish
  only:
    refs:
      - publish
      - master
  script:
    - echo //registry.npmjs.org/:_authToken=${NPM_TOKEN} > .npmrc
#    - echo //registry.npmjs.org/:_authToken=${NPM_TOKEN} > packages/auth/.npmrc
#    - sudo npm install --global can-npm-publish
#    - yarn config set registry https://registry.npmjs.org/
    - yarn config set cache-folder "$CI_PROJECT_DIR/_yarn_cache"
    - yarn install
    - npm whoami
    - lerna run build
    - lerna publish from-package --yes
